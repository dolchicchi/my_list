version: 2.1
jobs:
 build:
   docker:
   - image: circleci/ruby:2.6.5-node
     environment:
       - BUNDLER_VERSION: 2.1.4
       - RAILS_ENV: 'test'
   - image: circleci/mysql:5.6.51
     environment:
       - MYSQL_ALLOW_EMPTY_PASSWORD: 'true'
       - MYSQL_ROOT_HOST: '127.0.0.1'
   - image: cimg/node:14.19.0

   working_directory: ~/my_list


   steps:
   - checkout

   - restore_cache:
       keys:
       - v1-dependencies-{{ checksum "Gemfile.lock" }}
       - v1-dependencies-

   - run:
       name: install dependencies
       command: |
         gem install bundler -v 2.1.4
         bundle install --jobs=4 --retry=3 --path vendor/bundle

   - save_cache:
       paths:
       - ./vendor/bundle
       key: v1-dependencies-{{ checksum "Gemfile.lock" }}

   # Database setup
   - run: mv ./config/database.yml.ci ./config/database.yml

   # Database setup
   - run:
       name: DatabaseSetup
       command: |
          bundle exec rake db:create
          bundle exec rake db:schema:load

    - run:
      name: Setup Node.js via nvm
      command: |
        curl --silent -o- https://raw.githubusercontent.com/nvm-sh/nvm/v0.34.0/install.sh | bash
        echo 'export NVM_DIR="$HOME/.nvm"' >> $BASH_ENV
        echo 'source "$NVM_DIR/nvm.sh" --no-use' >> $BASH_ENV 
        source $BASH_ENV
        nvm install --latest-npm --no-progress
        nvm alias default
        sed -i -e 's/ --no-use//' $BASH_ENV
    - run:
      name: Version Change
      command: nvm use v14.19.0

   # yarn install
   - run:
       name: yarn Install
       command: yarn install


   - run: bundle exec bin/webpack

   # run tests!
   - run:
       name: RSpec 並列処理
       command: |
         mkdir /tmp/test-results
         TEST_FILES="$(circleci tests glob "**/spec/**/*_spec.rb" | circleci tests split --split-by=timings)"

         bundle exec rspec --format progress \
                         --out /tmp/test-results/rspec.xml \
                         --format progress \
                         $TEST_FILES